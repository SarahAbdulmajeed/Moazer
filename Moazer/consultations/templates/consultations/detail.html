{% extends 'main/base.html' %}
{% block title %}تفاصيل الاستشارة{% endblock %}
{% block content %}

<div>
  <div>
    <div>
      <td>الرقم: {{ c.id }}</td><br>
      <td>الحالة: {{ c.get_status_display }}</td><br>
      <td>النوع: {{ c.get_type_display }} </td><br>
      <td >تاريخ الانشاء: {{ c.created_at }}</td><br>
      <td>الطالب: {{ c.student.username }} — الخبير: {{ c.expert.username }}</td><br>
      <hr>
      <h5>المحادثة</h5>
      <div id="chat-box">
        {% include "consultations/messages.html" with c=c %}
      </div>

      <form method="post">
        {% csrf_token %}
        <input type="hidden" name="action" value="send_message">
        <textarea name="message" rows="2" placeholder="اكتب رسالتك..."></textarea>
        <button type="submit">إرسال</button>
      </form>
    </div>
  </div>

  <div>
    <div>
      <h5>تفاصيل</h5>

      <td>العنوان:{{ c.title }}</td><br>
      <p>{{ c.description|linebreaks }}</p>
      <h6>المرفقات</h6>
      <ul>
        {% for a in c.attachments.all %}
          <li><a href="{{ a.file.url }}" target="_blank">ملف #{{ a.id }}</a> — {{ a.created_at|date:"Y-m-d H:i" }}</li>
        {% empty %}
          <li>لا توجد مرفقات.</li>
        {% endfor %}
      </ul>

      {% if c.student_id == request.user.id and c.status == "ACTIVE" %}
      <hr>
        <form method="post">
          {% csrf_token %}
          <input type="hidden" name="action" value="end_consultation">
          <button type="submit">إنهاء الاستشارة</button>
        </form>
      {% endif %}

    {% if is_expert and c.status in "ACTIVE PENDING" %}
        <hr>
        <form method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="expert_end">
            <button type="submit">إنهاء الاستشارة</button>
        </form>
    {% endif %}

      {% if is_expert and c.status == "PENDING" %}
        <hr>
        <form method="post">
          {% csrf_token %}
          <button name="action" value="expert_accept">قبول</button>
          <button name="action" value="expert_reject">رفض</button>
        </form>
      {% endif %}
    </div>
  </div>
</div>
<script>
    (function(){
      // Reference to the chat container
      const box = document.getElementById('chat-box');
      // Endpoint that returns the partial HTML for chat messages
      const url = "{% url 'consultations:messages_partial' consultation_id=c.id %}";

      // Function to fetch and refresh chat messages
      function refreshMessages() {
        fetch(url, {headers: {'X-Requested-With':'XMLHttpRequest'}})
          .then(r => r.text())
          .then(html => {
            const atBottom = (box.scrollTop + box.clientHeight + 5) >= box.scrollHeight;
            box.innerHTML = html;
            // If user was at bottom → auto-scroll to keep view pinned
            if (atBottom) {
              box.scrollTop = box.scrollHeight;
            }
          })
          .catch(() => {});
      }
        // On first load → scroll to bottom
        box.scrollTop = box.scrollHeight;
        // Poll server every 3 seconds to refresh messages
        setInterval(refreshMessages, 3000);
    })();
  </script>
{% endblock %}
